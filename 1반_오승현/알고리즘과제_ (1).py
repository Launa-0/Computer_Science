# -*- coding: utf-8 -*-
"""ì•Œê³ ë¦¬ì¦˜ê³¼ì œ .ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1BbSRIfadnB-7TGc0AEvCBlq8KidklUQE

## ì„œìš¸ ì§€í•˜ì²  í˜¼ìž¡ë„ë¥¼ ê³ ë ¤í•œ ìµœì  ê²½ë¡œ íƒìƒ‰ ì•Œê³ ë¦¬ì¦˜
ì•Œê³ ë¦¬ì¦˜ 2025-2í•™ê¸° ê¸°ë§ê³¼ì œ
"""

!sudo apt-get install -y fonts-nanum
!sudo fc-cache -fv
!rm ~/.cache/matplotlib -rf

import matplotlib.pyplot as plt
plt.rc('font', family='NanumBarunGothic')

import pandas as pd
import heapq
import time
from collections import defaultdict
import networkx as nx
import matplotlib.pyplot as plt

edges_df = pd.read_csv(
    "ì„œìš¸êµí†µê³µì‚¬ ì—­ê°„ê±°ë¦¬ ë° ì†Œìš”ì‹œê°„_240810.csv",
    encoding="cp949"
)

transfer_df = pd.read_csv(
    "ì„œìš¸êµí†µê³µì‚¬_í™˜ìŠ¹ì—­ê±°ë¦¬ ì†Œìš”ì‹œê°„ ì •ë³´_20250331.csv",
    encoding="cp949"
)

crowd_df = pd.read_csv(
    "ì„œìš¸êµí†µê³µì‚¬_ì§€í•˜ì² í˜¼ìž¡ë„ì •ë³´_20250930.csv",
    encoding="cp949"
)

def time_to_sec(t):
    if isinstance(t, str) and ":" in t:
        m, s = t.split(":")
        return int(m) * 60 + int(s)
    return int(t)

edges_df["ì†Œìš”ì‹œê°„(ì´ˆ)"] = edges_df["ì†Œìš”ì‹œê°„"].apply(time_to_sec)

def get_congestion(line, station, day="í‰ì¼", time_col="8ì‹œ00ë¶„"):
    df = crowd_df[
        (crowd_df["í˜¸ì„ "] == int(line)) &
        (crowd_df["ì¶œë°œì—­"] == station) &
        (crowd_df["ìš”ì¼êµ¬ë¶„"] == day)
    ]

    if df.empty or time_col not in crowd_df.columns:
        return crowd_df[time_col].mean()

    return df[time_col].mean()

graph = defaultdict(list)

BETA = 2.0             # í˜¼ìž¡ë„ ê°€ì¤‘ì¹˜
ALPHA_TRANSFER = 1.0   # í™˜ìŠ¹ ê°€ì¤‘ì¹˜

# 4-1. ê°™ì€ í˜¸ì„  ë‚´ ì¸ì ‘ì—­
edges_sorted = edges_df.sort_values(by=["í˜¸ì„ ", "ì—°ë²ˆ"])

for line, group in edges_sorted.groupby("í˜¸ì„ "):
    group = group.sort_values("ì—°ë²ˆ").reset_index(drop=True)

    for i in range(len(group) - 1):
        s1 = group.loc[i, "ì—­ëª…"]
        s2 = group.loc[i + 1, "ì—­ëª…"]

        base_time = group.loc[i, "ì†Œìš”ì‹œê°„(ì´ˆ)"]
        congestion = get_congestion(line, s1)

        weight = base_time + BETA * congestion

        u = (s1, str(line))
        v = (s2, str(line))

        graph[u].append((v, weight))
        graph[v].append((u, weight))

# 4-2. í™˜ìŠ¹ ê°„ì„ 
for _, row in transfer_df.iterrows():
    station = row["í™˜ìŠ¹ì—­ëª…"]
    line_from = str(row["í˜¸ì„ "])
    line_to   = str(row["í™˜ìŠ¹ë…¸ì„ "])

    t_time = time_to_sec(row["í™˜ìŠ¹ì†Œìš”ì‹œê°„"])

    u = (station, line_from)
    v = (station, line_to)

    graph[u].append((v, ALPHA_TRANSFER * t_time))
    graph[v].append((u, ALPHA_TRANSFER * t_time))

def dijkstra_with_path(start, end):
    pq = [(0, start)]
    dist = {start: 0}
    prev = {}

    while pq:
        cur_dist, cur = heapq.heappop(pq)

        if cur_dist > dist.get(cur, float("inf")):
            continue

        if cur == end:
            break

        for nxt, w in graph.get(cur, []):
            nd = cur_dist + w
            if nd < dist.get(nxt, float("inf")):
                dist[nxt] = nd
                prev[nxt] = cur
                heapq.heappush(pq, (nd, nxt))

    path = []
    cur = end
    while cur in prev:
        path.append(cur)
        cur = prev[cur]
    path.append(start)
    path.reverse()

    return path, dist.get(end, None)

print("ë…¸ë“œ ìˆ˜:", len(graph))

start = ("ì„œìš¸ì—­", "1")
end   = ("ê°•ë‚¨", "2")

t0 = time.perf_counter()
path, cost = dijkstra_with_path(start, end)
t1 = time.perf_counter()

print("ìµœì  ê²½ë¡œ:")
for p in path:
    print(p)

print("ì´ ë¹„ìš©:", cost)
print("ì‹¤í–‰ ì‹œê°„:", t1 - t0)

G = nx.Graph()

for i in range(len(path) - 1):
    G.add_edge(path[i], path[i + 1])

plt.figure(figsize=(12, 6))
pos = nx.spring_layout(G, seed=42)

nx.draw(
    G,
    pos,
    with_labels=True,
    node_size=2200,
    node_color="lightblue",
    edge_color="gray",
    font_size=9,
    font_weight="bold",
    font_family="NanumBarunGothic"  # ðŸ”¥ ì´ ì¤„ì´ í•µì‹¬
)

plt.title("í˜¼ìž¡ë„Â·í™˜ìŠ¹ì„ ê³ ë ¤í•œ ì„œìš¸ ì§€í•˜ì²  ìµœì  ê²½ë¡œ")
plt.show()

print("ë…¸ë“œ ìˆ˜:", len(graph))

start = ("ì² ì‚°", "7")
end   = ("ì›”ê³¡", "6")

t0 = time.perf_counter()
path, cost = dijkstra_with_path(start, end)
t1 = time.perf_counter()

print("ìµœì  ê²½ë¡œ:")
for p in path:
    print(p)

print("ì´ ë¹„ìš©:", cost)
print("ì‹¤í–‰ ì‹œê°„:", t1 - t0)

G = nx.Graph()

for i in range(len(path) - 1):
    G.add_edge(path[i], path[i + 1])

plt.figure(figsize=(12, 6))
pos = nx.spring_layout(G, seed=42)

nx.draw(
    G,
    pos,
    with_labels=True,
    node_size=2200,
    node_color="lightblue",
    edge_color="gray",
    font_size=9,
    font_weight="bold",
    font_family="NanumBarunGothic"  # ðŸ”¥ ì´ ì¤„ì´ í•µì‹¬
)

plt.title("í˜¼ìž¡ë„Â·í™˜ìŠ¹ì„ ê³ ë ¤í•œ ì„œìš¸ ì§€í•˜ì²  ìµœì  ê²½ë¡œ")
plt.show()